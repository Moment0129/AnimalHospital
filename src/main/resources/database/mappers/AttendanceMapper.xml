<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vet.main.attendance.AttendanceDAO">

	<sql id="forPager">
		<choose>
			<when test="kind=='apTitle'">
				EMPNAME
			</when>
			<when test="kind=='apContents'">
				POSITIONNAME
			</when>
			<when test="kind=='apContents'">
				DEPTNAME
			</when>
			<otherwise>
				ATTSTATE
			</otherwise>
		</choose>
	</sql>
	

	<insert id="setAttIn" parameterType="AttendanceVO">
		INSERT INTO ATTENDANCE
		(ATTNO, USERNAME, ATTDATE, ATTIN, ATTSTATE)
		VALUES
		(NULL, #{username}, CAST(DATE_ADD(NOW(), INTERVAL 9 HOUR)AS date), #{attIn}, 1)
	</insert>
	
	<update id="setAttOut" parameterType="AttendanceVO">
		UPDATE ATTENDANCE
		SET
		ATTOUT = #{attOut}
		WHERE
		ATTNO = #{attNo} AND
		USERNAME = #{username}
	</update>
	
	<select id="checkDate" parameterType="AttendanceVO">
		SELECT *
		FROM ATTENDANCE
		WHERE USERNAME = #{username}
		AND ATTDATE = CAST(DATE_ADD(NOW(), INTERVAL 9 HOUR)AS date)
	</select>
	
	<select id="getAttList" parameterType="AttendanceVO" resultType="AttendanceVO">
		<![CDATA[
			SELECT A.*, E.EMPNAME, P.POSITIONNAME, D.DEPTNAME
			FROM ATTENDANCE A
			RIGHT OUTER JOIN EMP E ON A.USERNAME = E.USERNAME
			INNER JOIN POSITION P ON E.POSITIONNO = P.POSITIONNO
			INNER JOIN DEPARTMENT D ON E.DEPTNO = D.DEPTNO
			ORDER BY 
			    ATTIN IS NOT NULL DESC,
			    ATTIN,
			    CASE WHEN ASCII(SUBSTRING(E.EMPNAME, 1, 1)) < 123 THEN 2 ELSE 1 END,
			    E.EMPNAME
		]]>
	</select>
	
	<select id="getHireDate" parameterType="String">
		SELECT DATE_FORMAT(HIREDATE, '%Y-%m-%d')
		FROM EMP
		WHERE USERNAME = #{username};
	</select>
	
	<select id="getCurDate">
		SELECT CAST(DATE_ADD(NOW(), INTERVAL 9 HOUR)AS date)
		FROM DUAL
	</select>

</mapper>